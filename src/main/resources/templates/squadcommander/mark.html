<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Отметить ребят</title>
	<link rel="stylesheet" href="/assets/default_style.css">
	<link rel="icon" href="/icon.png">
	<script src="/public_resources/sweetalert2.js"></script>
</head>

<body>
	<!--CSRF Attack Protection (Getting from thymeleaf for JS)-->
	<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
	<div id="navbar"></div>
	<div id="dashboard">
		<div id="content">
			<div class="card">
				<h3>Добро пожаловать, <span th:text="${login}"></span>!</h3>
				<p>Это ваша панель командира. Сверху вы можете перейти в другой раздел сайта. Ниже вы можете отметить
					ребят. Приятного пользования!</p>
			</div>
			<div class="card">
				<h3><b>КАК ПРАВИЛЬНО ОТМЕТИТЬ???</b></h3>
				<p>В форме ниже отметьте ребят, которые <strong>ПРИСУТСТВОВАЛИ</strong> на событии. Выберите событие
					в селекторе
					над таблицей и нажмите "Отправить".<br><strong>Отправленные данные изменить нельзя!</strong></p>
			</div>
			<div class="card">
				<h3>Отметьте ПРИСУТСТВОВАВШИХ ребят:</h3>
				<form th:action="@{/squadcommander/mark}" method="post" id="markForm">
					<label>Выберите событие:</label>
					<select name="statsType" id="statsType" onchange="handleSelectChange(this)" required>
						<option th:each="entry : ${event_types_map}" th:value="${entry.getEvent()}"
							th:text="${entry.getName()}">
						</option>
						<option value="unknown-event">Другое событие...</option>
					</select>
					<table id="markTable">
						<thead>
							<tr>
								<th>Выбрать</th>
								<th>Фамилия</th>
								<th>Имя</th>
								<th>Причина</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="human, iterStat : ${humanList}">
								<td>
									<input class="custom-checkbox" type="checkbox" name="selectedIds"
										th:value="${human.id}" th:id="'checkbox-' + ${iterStat.index}" />
								</td>
								<td th:text="${human.lastname}">Фамилия</td>
								<td th:text="${human.name}">Имя</td>
								<td>
									<select class="details-input" th:name="'details[' + ${human.id} + ']'"
										th:id="'details-' + ${iterStat.index}">
										<option th:each="entry : ${reasons_for_absences_map}" th:value="${entry.key}"
											th:text="${entry.value}">
										</option>
									</select>
								</td>
							</tr>
						</tbody>
					</table>
					<button type="button" onclick="submitData()">Отправить</button>
				</form>
			</div>
			<script>
				async function fetchData(url) {
					try {
						const response = await fetch(url);
						if (!response.ok) {
							throw new Error(`Ошибка HTTP: ${response.status}`);
						}
						return await response.json();
					} catch (error) {
						console.error('Ошибка при получении данных:', error);
						Swal.fire({
							title: "Ошибка!",
							text: "Ошибка при получении информации. Пожалуйста, перезагрузите страницу. \nОшибка: " + error,
							icon: "error"
						});
						return "";
					}
				}
				function submitData() {
					Swal.fire({
						title: 'Вы уверены?',
						text: "Вы точно выбрали всех ребят? \n Вы выбрали тот тип статистики? Выбран тип статистики: " + getSelectedText(),
						icon: 'warning',
						showCancelButton: true,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonText: 'Да, отправить',
						cancelButtonText: 'Отмена'
					}).then((result) => {
						if (result.isConfirmed) {
							sendData();
						}
					});
				}

				function sendData() {
					const uncheckedPeople = [];
					// Проходим по всем чекбоксам
					const checkboxes = document.querySelectorAll('.custom-checkbox');
					checkboxes.forEach(checkbox => {
						if (!checkbox.checked) {
							const row = checkbox.closest('tr');
							const reasonSelect = row.querySelector('.details-input');
							uncheckedPeople.push(JSON.stringify(
								{
									id: checkbox.value,
									reason: reasonSelect.value // Получаем значение причины
								}
							));
						}
					});
					var selectElement = document.getElementById('statsType');
					const bodyData = {
						uncheckedPeople: uncheckedPeople,
						statsType: selectElement.value
					};
					var csrfToken = document.querySelector('input[name="_csrf"]').value;
					// Отправляем данные на сервер
					fetch('/squadcommander/mark', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'X-CSRF-TOKEN': csrfToken,
						},
						body: JSON.stringify(bodyData),
					})
						.then(response => response.json())
						.then(data => {
							console.log('mark success:', data);
							Swal.fire({
								title: "Успех!",
								text: "Ребята отмечены",
								icon: "success"
							});
						})
						.catch((error) => {
							console.error('mark error:', error);
							Swal.fire({
								title: "Провал!",
								text: "Ошибка при выставлении отметок\n" + error,
								icon: "error"
							});
						});
				}

				function getSelectedText() {
					var selectElement = document.getElementById('statsType');
					var selectedIndex = selectElement.selectedIndex;
					var selectedText = selectElement.options[selectedIndex].text;
					return selectedText;
				}
				let eventTypesWithReasons = "";
				async function handleSelectChange(selectElement) {
					const selectedValue = selectElement.value;
					if (selectElement.value == "unknown-event") {
						console.log("Creating custom event...");
						Swal.fire({
							title: 'Введите название события',
							text: "Так, чтобы можно было понять, что это.",
							input: 'text',
							showCancelButton: true,
							confirmButtonText: 'Сохранить',
						}).then((result) => {
							if (result.value) {
								console.log('User entered: ', result.value);
								var main = document.getElementById('statsType');
								const option = document.createElement('option');
								option.value = result.value;
								option.text = result.value;
								selectElement.add(option);
								selectElement.value = result.value;
								selectElement.disabled = true;
								Swal.fire({
									title: "Готово!",
									text: "Событие указано. Если вы хотите выбрать другое, перезагрузите страницу.",
									icon: "success"
								});
							}
						});
						showColumn(3);
						return;
					}
					if (eventTypesWithReasons === "") {
						eventTypesWithReasons = await fetchData("/api/get_event_types_with_reasons");
					}
					if (!eventTypesWithReasons.some(event => event.event === selectedValue)) {
						hideColumn(3);
					} else {
						showColumn(3);
					}
				}
				function hideColumn(columnIndex) {
					console.log('Hiding column');
					const table = document.getElementById('markTable');
					const rows = table.rows;
					for (let i = 0; i < rows.length; i++) {
						const cells = rows[i].cells;
						if (cells.length > columnIndex) {
							cells[columnIndex].style.display = 'none';
						}
					}
				}
				function showColumn(columnIndex) {
					console.log('Showing column');
					const table = document.getElementById('markTable');
					const rows = table.rows;
					for (let i = 0; i < rows.length; i++) {
						const cells = rows[i].cells;
						if (cells.length > columnIndex) {
							cells[columnIndex].style.display = '';
						}
					}
				}
				document.addEventListener('DOMContentLoaded', function () {
					const checkboxes = document.querySelectorAll('.custom-checkbox');

					checkboxes.forEach(checkbox => {
						checkbox.addEventListener('change', function () {
							const index = this.id.split('-')[1];
							const selectInput = document.getElementById('details-' + index);

							if (selectInput) {
								selectInput.disabled = this.checked;
							}
						});
					});
				});
			</script>
			<script src="/assets/messagesUtil.js"></script>
			<script src="/squadcommander/navbar.js"></script>

</html>